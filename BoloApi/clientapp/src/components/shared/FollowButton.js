import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { MessageModel } from "./Model";


function FollowButton(props) {    const navigate = useNavigate();    const [loading, setLoading] = useState(false);    const [message, setMessage] = useState(new MessageModel());    const token = props.token;    const member = props.member;    const myself = localStorage.getItem("myself") == null ? null : JSON.parse(localStorage.getItem("myself"));    const [status, setStatus] = useState(null);       useEffect(() => {        setLoading(true);        fetch('//' + window.location.host + '/api/follow/Status/' + member.id, {            method: 'get',            headers: {                'Authorization': 'Bearer ' + token            }        })            .then(response => {                if (response.status === 401) {                    localStorage.removeItem("token");                    navigate("/login");                } else if (response.status === 200) {                    response.json().then(data => {                        setStatus(data.status);                    });                }            }).catch(error => {                this.setState(new MessageModel('danger', 'Unable to contact server'));            }).finally(() => {                setLoading(false);            });    }, [props.member, token]);        const askToFollow = () => {        setLoading(true);        fetch('//' + window.location.host + '/api/follow/ask/' + member.id, {            method: 'get',            headers: {                'Authorization': 'Bearer ' + token            }        })            .then(response => {                if (response.status === 401) {                    localStorage.removeItem("token");                    navigate("/login");                } else if (response.status === 200) {                    response.json().then(data => {                        console.log(data);                        setStatus(data.status);                        if (props.notify) {                            props.notify(member.id, status);                        }                    });                }            }).catch(() => {                this.setState(new MessageModel('danger', 'Unable to contact server'));            }).finally(() => {                setLoading(false);            });    }    const unFollow = () => {        setLoading(true);        fetch('//' + window.location.host + '/api/follow/unfollow/' + member.id, {            method: 'get',            headers: {                'Authorization': 'Bearer ' + token            }        })            .then(response => {                if (response.status === 401) {                    localStorage.removeItem("token");                    navigate("/login");                } else if (response.status === 200) {                    response.json().then(data => {                        //console.log(data);                        setStatus(data.status);                        if (props.notify) {                            props.notify(member.id, status);                        }                    });                } else {                    this.setState(new MessageModel('danger', 'Unable to process request'));                }            }).catch(() => {                this.setState(new MessageModel('danger', 'Unable to contact server'));            }).finally(() => {                setLoading(false);            });    }    const renderFollowButton = () => {        let followbtn = null;        if (!loading) {            if (status === 0) {                if (member.id !== myself.id) {                    followbtn = <button type="button" className="btn btn-danger btn-follow" onClick={askToFollow}>Follow</button>;                }            } else if (status === 1) {                followbtn = <button type="button" className="btn btn-blue btn-follow" onClick={unFollow}>Unfollow</button>;            }            else if (status === 2) {                followbtn = <button type="button" className="btn btn-danger" onClick={unFollow}>Requested</button>;            }        } else if (loading) {            followbtn = null;        }        return followbtn;    }    return <>{renderFollowButton()}</>;}export default FollowButton;